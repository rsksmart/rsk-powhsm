#! /usr/bin/env bash

if [[ $# -lt 3 ]]; then
    echo "Usage: $0 <checkpoint> <minimum_difficulty> <network>"
    exit 1
fi

if [[ "$3" == "regtest" ]]; then
    NETWORK="REGTEST"
elif [[ "$3" == "testnet" ]]; then
    NETWORK="TESTNET"
elif [[ "$3" == "mainnet" ]]; then
    NETWORK=""
else
    echo "Invalid network '$3'"
    exit 1
fi

pushd $(dirname $0) > /dev/null
BUILD_ROOT=$(pwd)
popd > /dev/null

HSM_ROOT=$(realpath $BUILD_ROOT/../../)

DOCKER_IMAGE=hsm:sgx
source $BUILD_ROOT/../../docker/check-image

BUILD_TARGET=build
if [[ "$(basename $0)" == "build-sgx-debug" ]]; then
    BUILD_TARGET=build-debug
fi
BUILD_CMD="\$SGX_ENVSETUP && make clean $BUILD_TARGET CHECKPOINT=$1 TARGET_DIFFICULTY=$2 NETWORK=$NETWORK"

DOCKER_USER="$(id -u):$(id -g)"

docker run -t --rm --user $DOCKER_USER -w /hsm2/firmware/src/sgx -v ${HSM_ROOT}:/hsm2 ${DOCKER_IMAGE} /bin/bash -c "$BUILD_CMD"
