name: "Code coverage"

on:
  push:

jobs:
  coverage:
    name: Run tests and generate coverage reports
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v3

      - name: Build the middleware docker image
        run: docker/mware/build

      - name: Run middleware coverage script
        run: middleware/test-all-coverage

      - name: "Upload middleware coverage report"
        uses: jakejarvis/s3-sync-action@7ed8b112447abb09f1da74f3466e4194fc7a6311
        with:
          args: --sse aws:kms --sse-kms-key-id ${{ secrets.CODECOVERAGE_KMS_KEY_ID }} --follow-symlinks --delete
        env:
          AWS_S3_BUCKET: ${{ secrets.CODECOVERAGE_S3_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.CODECOVERAGE_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.CODECOVERAGE_AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1
          SOURCE_DIR: middleware/coverage
          DEST_DIR: middleware_coverage_report

      # - name: Run firmware coverage script
      #   run: ledger/coverage/gen-coverage

      # - name: "Upload firmware coverage report"
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: firmware_coverage_report
      #     path: ledger/coverage/output
