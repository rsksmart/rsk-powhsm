#! /usr/bin/env bash

pushd $(dirname $0) > /dev/null
BUILD_ROOT=$(pwd)
popd > /dev/null

HSM_ROOT=$(realpath $BUILD_ROOT/../../)

DOCKER_IMAGE=hsm:ledger
source $BUILD_ROOT/../../docker/check-image

HEX_PATH="/hsm2/ledger/src/signer-certificate/bin/app.hex"
HASH_CMD="cd /opt && echo '*******************' && echo 'Build successful. Signer certificate hash:' && python -m hashapp.hashApp --hex $HEX_PATH && echo '*******************'"
BUILD_CMD="make clean && make && $HASH_CMD"

DOCKER_USER="$(id -u):$(id -g)"

docker run -t --rm --user $DOCKER_USER -w /hsm2/ledger/src/signer-certificate -v ${HSM_ROOT}:/hsm2 ${DOCKER_IMAGE} /bin/bash -c "$BUILD_CMD"
